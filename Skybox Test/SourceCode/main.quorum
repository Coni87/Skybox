use Libraries.Game.Game
use Libraries.Game.Graphics.Skybox
use Libraries.Game.Graphics.Camera
use Libraries.Game.InputMonitor
use Libraries.Interface.Events.KeyboardEvent
use Libraries.Game.Graphics.Model
use Libraries.Game.Graphics.Color
use Libraries.Compute.Vector3
use Libraries.Game.Graphics.DirectionalLight
use Libraries.Game.Graphics.Label
use Libraries.Game.Graphics.Drawable
use Libraries.Compute.Random

class Main is Game
    Skybox skybox
    Camera camera = undefined
    InputMonitor im
    KeyboardEvent button
    number x = 0
    number y = 0
    number z = 0

    Model table
    Model leg1
    Model leg2
    Model leg3
    Model leg4
    Color wood
    Color color

    Model apple
    Model orange
    DirectionalLight light
        
    Vector3 direction
    
    appleGrab = false
    orangeGrab = false
    integer numberOfApples = 0
    integer numberOfOranges = 0
    inventoryFull = false
    integer inventoryCount = 0
    
    Label inventory
    Label choice            
        
        
    action Main
        StartGame()
    end

    action CreateGame
        skybox:Load("iceflow_rt.png", "iceflow_lf.png", "iceflow_up.png", "iceflow_dn.png", "iceflow_ft.png", "iceflow_bk.png")
        SetSkybox(skybox)
        camera = GetCamera3D()
        camera:SetPosition(0, 0, 0)
        camera:LookAt(0, 0, 1)
        
        wood:SetColor(0.55, 0.40, 0.30, 1)
        
        table:LoadBox(15, 1, 15, wood)
        leg1:LoadCylinder(1, 10, 1, wood)
        leg2:LoadCylinder(1, 10, 1, wood)
        leg3:LoadCylinder(1, 10, 1, wood)
        leg4:LoadCylinder(1, 10, 1, wood)
        leg1:SetPosition(7, -5.5, 7)
        leg2:SetPosition(-7, -5.5, 7)
        leg3:SetPosition(7, -5.5, -7)
        leg4:SetPosition(-7, -5.5, -7)
        table:Add(leg1)
        table:Add(leg2)
        table:Add(leg3)
        table:Add(leg4)
        table:SetPosition(250,-10,150)
        Add(table)
        
        Color appleColor
        appleColor:SetColor(0.290, 0.71, 0.30, 1)
        apple:LoadSphere(3,3,3, appleColor)
        apple:SetPosition(5,2,0)
        table:Add(apple)

        Color orangeColor
        orangeColor:SetColor(1, 0.59, 0, 1)
        orange:LoadSphere (3,3,3,orangeColor)
        orange:SetPosition (-5, 2, 1)
        table:Add(orange)
        
        light:SetColor(0.75,0.75,1,1)
        light:SetDirection(table:GetX()+250,table:GetY()+100,table:GetZ()+150)
        Add(light)

        choice:SetText("Press A to pick up the apple, press O to pick up the Orange.")
        choice:SetPosition(table:GetX()- 150, table:GetY()+ 200)
        choice:SetSize(25)
        choice:SetColor(color:White())
        Add(choice)
        choice:Hide()


        inventory:SetText(numberOfApples + " apples" + " " + numberOfOranges + " oranges")
        inventory:SetColor(color:White())
        Drawable ccbox
        ccbox:LoadFilledRectangle(150, 25, color:Black())
        ccbox:SetPosition(200,500)
        ccbox:Add(inventory)
        Add (ccbox)

    end


    action Update(number seconds)
        if im:IsKeyPressed(button:RIGHT)
            x = x + 25 * seconds
            if x > 360
                x = 360
            end
            camera:SetYawPitchRoll(x,y,z)
            table:Show()
            apple:Show()
            orange:Show()
            
        elseif im:IsKeyPressed(button:LEFT)
            x = x - 25 * seconds
            if x < -360
                x = -360
            end
            camera:SetYawPitchRoll(x,y,z)
            table:Show()
            apple:Show()
            orange:Show()
        
        elseif im:IsKeyPressed(button:R)
            y = y + 25 * seconds
            camera:SetYawPitchRoll(x,y,z)
            if y > 90
                y = 90
            end
            table:Show()
            apple:Show()
            orange:Show()

        elseif im:IsKeyPressed(button:C)
            y = y - 25 * seconds
            camera:SetYawPitchRoll(x,y,z)
            if y < 0
                y = 0
            end
            table:Show()
            apple:Show()
            orange:Show()
        end
        
        if im:IsKeyPressed(button:W)
            camera:LookAt(table:GetGlobalPosition())  
            if im:IsKeyPressed(button:UP)
                direction = camera:GetDirection():Copy()
                direction:Scale(25 * seconds)
                camera:Move(direction)

                x = x
                y = 0
                z = 0
                camera:SetYawPitchRoll(x,y,z)
            end
        end

        if im:IsKeyPressed(button:X)
            Exit()
        end

        if im:IsKeyPressed(button:S)
            x = 0
            y = 0
            z = 0
            camera:SetYawPitchRoll(x,y,z)
        end
        
        Vector3 person = camera:GetPosition():Copy()      
        inventoryCount = numberOfApples + numberOfOranges

        if person:Distance(apple:GetGlobalPosition()) < 50 and inventoryFull = false 
            choice:Show()
            if im:IsKeyPressed(button:A)and appleGrab = false 
                apple:Hide()
                appleGrab = true
                numberOfApples = numberOfApples + 1 
                inventory:SetText(numberOfApples + " apples" + " " + numberOfOranges + " oranges")
            end        

            if im:IsKeyPressed(button:O) and orangeGrab = false
                orange:Hide()
                orangeGrab = true
                numberOfOranges = numberOfOranges + 1
                inventory:SetText(numberOfApples + " apples" + " " + numberOfOranges + " oranges")
            end

        end

        if person:Distance(table:GetGlobalPosition()) < 20
            Random randomX
            Random randomZ
            joe = randomX:RandomIntegerBetween(0, 360)
            bob = randomZ:RandomInteger(200)
            number newX = cast(number, joe)
            number newZ = cast(number, bob)
            table:Hide()
            table:SetPosition(newX, table:GetY(), newZ)
            light:SetDirection(table:GetX()+250,table:GetY()+100,table:GetZ()+150)
            appleGrab = false
            orangeGrab = false
            choice:Hide()
        end

        if inventoryCount = 4 and inventoryFull = false
            inventoryFull = true
            Label full
            full:SetText("Your Inventory is Full!")
            full:SetColor(color:Red())
            full:SetSize(36)
            full:SetPosition(300, 350)
            Add (full)
            Remove(table)
        end
    end
end

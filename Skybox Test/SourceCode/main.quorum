use Libraries.Game.Game
use Libraries.Game.Graphics.Skybox
use Libraries.Game.Graphics.Camera
use Libraries.Game.InputMonitor
use Libraries.Interface.Events.KeyboardEvent
use Libraries.Game.Graphics.Model
use Libraries.Game.Graphics.Color
use Libraries.Compute.Vector3
use Libraries.Game.Graphics.DirectionalLight
use Libraries.Game.Graphics.Label
use Libraries.Game.Graphics.Drawable
use Libraries.Compute.Random

class Main is Game
    Skybox skybox
    Camera camera = undefined
    InputMonitor im
    KeyboardEvent button
    number x = 0
    number y = 0
    number z = 0

    Model table
    Model leg1
    Model leg2
    Model leg3
    Model leg4
    Color wood
    Color color

    Model apple
    DirectionalLight light
        
    Vector3 direction
    
    appleGrab = false
    integer numberOfApples = 0
    inventoryFull = false

    action Main
        StartGame()
    end

    action CreateGame
        skybox:Load("iceflow_rt.png", "iceflow_lf.png", "iceflow_up.png", "iceflow_dn.png", "iceflow_ft.png", "iceflow_bk.png")
        SetSkybox(skybox)
        camera = GetCamera3D()
        camera:SetPosition(0, 0, 0)
        camera:LookAt(0, 0, 1)
        
        wood:SetColor(0.55, 0.40, 0.30, 1)
        
        table:LoadBox(15, 1, 15, wood)
        leg1:LoadCylinder(1, 10, 1, wood)
        leg2:LoadCylinder(1, 10, 1, wood)
        leg3:LoadCylinder(1, 10, 1, wood)
        leg4:LoadCylinder(1, 10, 1, wood)
        leg1:SetPosition(7, -5.5, 7)
        leg2:SetPosition(-7, -5.5, 7)
        leg3:SetPosition(7, -5.5, -7)
        leg4:SetPosition(-7, -5.5, -7)
        table:Add(leg1)
        table:Add(leg2)
        table:Add(leg3)
        table:Add(leg4)
        table:SetPosition(250,-10,150)
        Add(table)

        apple:LoadSphere(3,3,3,color:Red())
        apple:SetPosition(5,2,0)
        table:Add(apple)
        
        light:SetColor(0.75,0.75,1,1)
        light:SetDirection(250,100,150)
        Add(light)
    end


    action Update(number seconds)
        if im:IsKeyPressed(button:RIGHT)
            x = x + 25 * seconds
            if x > 360
                x = 360
            end
            camera:SetYawPitchRoll(x,y,z)
            table:Show()
            apple:Show()
        
        elseif im:IsKeyPressed(button:LEFT)
            x = x - 25 * seconds
            if x < -360
                x = -360
            end
            camera:SetYawPitchRoll(x,y,z)
            table:Show()
            apple:Show()
        
        elseif im:IsKeyPressed(button:UP)
            y = y + 25 * seconds
            camera:SetYawPitchRoll(x,y,z)
            if y > 90
                y = 90
            end
            table:Show()
            apple:Show()

        elseif im:IsKeyPressed(button:DOWN)
            y = y - 25 * seconds
            camera:SetYawPitchRoll(x,y,z)
            if y < 0
                y = 0
            end
            table:Show()
            apple:Show()
        end
        
        if im:IsKeyPressed(button:W)
            camera:LookAt(table:GetGlobalPosition())  
            if im:IsKeyPressed(button:R)
                direction = camera:GetDirection():Copy()
                direction:Scale(25 * seconds)
                camera:Move(direction)

                x = x
                y = 0
                z = 0
                camera:SetYawPitchRoll(x,y,z)
            end
        end

        if im:IsKeyPressed(button:X)
            Exit()
        end

        if im:IsKeyPressed(button:A)
            x = 0
            y = 0
            z = 0
            camera:SetYawPitchRoll(x,y,z)
        end
        
        Vector3 person = camera:GetPosition():Copy()
        if person:Distance(apple:GetGlobalPosition()) < 25 and appleGrab = false
            apple:Hide()
            appleGrab = true
            numberOfApples = numberOfApples + 1
            Label inventory
            inventory:SetText(numberOfApples + " apples")            
            inventory:SetColor(color:White())
            Drawable ccbox
            ccbox:LoadFilledRectangle(75, 25, color:Black())
            ccbox:SetPosition(200,500)
            ccbox:Add(inventory)
            Add (ccbox)      
        end

        if person:Distance(table:GetGlobalPosition()) < 20
            Random randomX
            Random randomZ
            joe = randomX:RandomIntegerBetween(0, 360)
            bob = randomZ:RandomInteger(200)
            number newX = cast(number, joe)
            number newZ = cast(number, bob)
            table:Hide()
            camera:LookAt(0,0,0)
            table:SetPosition(newX, table:GetY(), newZ)
            appleGrab = false
        end

        if numberOfApples = 5 and inventoryFull = false
            inventoryFull = true
            Label full
            full:SetText("Your Inventory is Full!")
            full:SetColor(color:Red())
            full:SetSize(36)
            full:SetPosition(300, 350)
        end
    end
end
